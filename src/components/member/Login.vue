<template class="contents__body">
  <div>
    <div class="form__logo">
      <router-link to="/">
        <svg
          class="logo"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 1690 300"
        >
          <path
            d="M1614.9,90c41.48,0,75.1,33.62,75.1,75.1v-35.11c0-71.79-58.2-129.99-129.99-129.99h0c-6.8,0-13.49,.52-20.01,1.53-62.3,9.62-110,63.48-110,128.48v40c0,16.18,2.96,31.67,8.37,45.95,13.18,34.87,40.92,62.58,75.81,75.72,8.24,3.1,16.88,5.4,25.82,6.78,6.52,1.01,13.19,1.53,19.99,1.53h0c16.18,0,31.67-2.97,45.97-8.37,34.85-13.17,62.54-40.89,75.7-75.74,5.01-13.29,7.92-27.61,8.3-42.56-.89-29.6-25.14-53.33-54.96-53.33s-55,24.62-55,55v15c0,11.05-8.95,20-20,20s-20-8.95-20-20v-25.1c0-41.37,33.53-74.9,74.9-74.9Z"
          />
          <path
            d="M805,0h-189.84c-30.46,0-55.16,24.69-55.16,55.16h0c0,30.29,24.55,54.84,54.84,54.84h.34c1.77-26.64,17.43-49.47,39.81-61.32,10.46-5.54,22.38-8.68,35.04-8.68h0c39.73,0,72.22,30.92,74.78,70h-.06c-2.53-28.03-26.07-50-54.76-50h0c-28.69,0-52.24,21.97-54.76,50h-.24V244.84c0,30.46,24.69,55.16,55.16,55.16h0c30.29,0,54.84-24.55,54.84-54.84V110h40c30.38,0,55-24.62,55-55h0c0-30.38-24.62-55-55-55Z"
          />
          <path
            d="M130.01,0h0c-6.8,0-13.49,.52-20.01,1.53C47.7,11.16,0,65.01,0,130.01v114.83c0,30.46,24.69,55.16,55.16,55.16h0c30.29,0,54.84-24.55,54.84-54.84v-80.26c0-41.37,33.53-74.9,74.9-74.9h0c41.48,0,75.1,33.62,75.1,75.1v-35.11C260,58.2,201.8,0,130.01,0Z"
          />
          <path
            d="M205,120h0c-30.38,0-55,24.62-55,55v69.84c0,30.46,24.69,55.16,55.16,55.16h0c30.29,0,54.84-24.55,54.84-54.84v-70.16c0-30.38-24.62-55-55-55Z"
          />
          <path
            d="M1355,0h-75c-6.8,0-13.48,.53-20,1.53-62.3,9.62-110,63.48-110,128.48v114.83c0,30.46,24.69,55.16,55.16,55.16h0c30.29,0,54.84-24.55,54.84-54.84v-100.26c0-19.67,7.6-37.56,20-50.93,5.73-6.17,12.49-11.38,20-15.34,.13-.07,.26-.13,.4-.2,10.33-5.37,22.06-8.43,34.5-8.43h0c1.72,0,3.41,.08,5.1,.19,1.92,.13,3.82,.32,5.7,.59-25.93,4.38-45.68,26.92-45.7,54.1v.04h0v120c0,13.33,4.74,25.55,12.61,35.08,10.1,12.22,25.37,20,42.46,20h.16c17.05,0,32.27-7.79,42.31-20,7.78-9.46,12.45-21.56,12.45-34.76V55c0-30.38-24.62-55-55-55Z"
          />
          <path
            d="M1000,0h0c-71.8,0-130,58.2-130,130v40c0,71.8,58.2,130,130,130h0c71.8,0,130-58.2,130-130v-40c0-71.8-58.2-130-130-130Zm55,158.46c0,30.38-24.62,55-55,55h0c-30.38,0-55-24.62-55-55v-16.92c0-30.38,24.62-55,55-55h0c30.38,0,55,24.62,55,55v16.92Z"
          />
          <path
            d="M485,0h-150c-30.38,0-55,24.62-55,55V244.84c0,30.46,24.69,55.16,55.16,55.16h0c30.29,0,54.84-24.55,54.84-54.84v-100.26c0-19.67,7.6-37.56,20-50.93,5.73-6.17,12.49-11.38,20-15.34,10.42-5.5,22.29-8.63,34.9-8.63h0c1.72,0,3.41,.08,5.1,.19,1.92,.13,3.82,.32,5.7,.59-25.93,4.38-45.68,26.92-45.7,54.1v.04c0,30.42,24.66,55.08,55.08,55.08h.16c27.13,0,49.64-19.73,53.99-45.62,.41-2.47,.66-4.99,.73-7.56,.03,1.05,.04,2.11,.04,3.17V55c0-30.38-24.62-55-55-55Z"
          />
          <path
            d="M485.08,190h-.16c-17.94,0-33.86,8.6-43.89,21.9-6.93,9.19-11.04,20.62-11.04,33.02,0,13.33,4.74,25.55,12.61,35.08,10.1,12.22,25.37,20,42.46,20h.16c17.05,0,32.27-7.79,42.31-20,7.78-9.46,12.45-21.56,12.45-34.76v-.31c0-8.98-2.17-17.44-5.98-24.92-9.08-17.8-27.58-30-48.94-30Z"
          />
        </svg>
      </router-link>
    </div>
    <div class="form__box">
      <h1>Connect your wallet</h1>
      <p v-text="warning"></p>
      <div class="form__footer">
        <button v-if="isMobile" @click="signInMobile()">
          <div class="spinner" :class="{ active: isSpinnerActive }"></div>
          <span v-show="!isSpinnerActive">CONNECT</span>
        </button>
        <button v-else @click="signIn()">
          <div class="spinner" :class="{ active: isSpinnerActive }"></div>
          <span v-show="!isSpinnerActive">METAMASK</span>
        </button>
      </div>
    </div>
  </div>
</template>

<script>
import MetaMaskOnboarding from '@metamask/onboarding'
import { mapState } from 'vuex'
import { getMember } from '../../api/member'
import { menuDeactivate } from '../../mixin'

export default {
  name: 'Login',
  mixins: [menuDeactivate],
  data() {
    return {
      warning: '',
      isSpinnerActive: false,
    }
  },
  computed: {
    isMobile() {
      return this.$isMobile()
    },
    ...mapState({
      justSignedUp: (state) => state.auth.justSignedUp,
    }),
  },
  beforeRouteEnter(to, from, next) {
    window.scrollTo({ top: 0 })
    next({
      query: {
        redirect: from.fullPath,
      },
    })
  },
  methods: {
    async signIn() {
      if (this.isSpinnerActive) {
        return
      }
      try {
        if (MetaMaskOnboarding.isMetaMaskInstalled()) {
          this.isSpinnerActive = true
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts',
          })
          if (accounts.length > 0) {
            const address = accounts[0]
            const cognitoUser = await this.$store.dispatch(
              'AUTH_SIGN_IN_AND_UP',
              {
                address: address,
              },
            )
            const signature = await window.ethereum.request({
              method: 'personal_sign',
              params: [address, cognitoUser.challengeParam.message],
            })
            await this.$store.dispatch('AUTH_VERIFY_USER', {
              cognitoUser,
              signature,
            })
            const authenticatedUser = await this.$store.dispatch(
              'AUTH_CHECK_CURRENT_USER',
            )
            const member = await getMember(authenticatedUser.username)
            await this.$store.dispatch('CURRENT_USER', member)
            this.$store.commit(
              'WALLET_CHAIN',
              parseInt(window.ethereum.networkVersion),
            )
            this.$store.commit('WALLET_ACCOUNT', address)
            this.redirectAfterLogin()
          }
        } else {
          const onboarding = new MetaMaskOnboarding()
          onboarding.startOnboarding()
        }
      } catch (error) {
        if (error.code === 4001) {
          // INFO] User denied message signature
          this.warning = ''
        } else if (error.code === -32002) {
          this.warning = 'Please check your metamask'
        } else {
          this.warning = 'Oops, something went wrong! Please try again'
        }
        await this.$store.dispatch('AUTH_LOGOUT')
      } finally {
        this.isSpinnerActive = false
      }
    },
    async signInMobile() {
      if (this.isSpinnerActive) {
        return
      }

      try {
        this.isSpinnerActive = true
        const { connector, address } = await this.$store.dispatch(
          'SET_UP_WALLET_CONNECTION',
        )
        if (connector) {
          let signature = null
          const cognitoUser = await this.$store.dispatch(
            'AUTH_SIGN_IN_AND_UP',
            {
              address: address,
            },
          )
          if (cognitoUser) {
            this.$store.commit('TOGGLE_CONFIRM_MODAL')
            const ok =
              await this.$root.$children[0].$refs.confirmModal.waitForAnswer()
            if (ok) {
              try {
                signature = await connector.signPersonalMessage([
                  cognitoUser.challengeParam.message,
                  address,
                ])
              } catch (error) {
                this.isSpinnerActive = false
                connector.killSession()
                await this.$store.dispatch('AUTH_LOGOUT')
                throw error
              }
            }
          }

          if (signature) {
            await this.$store.dispatch('AUTH_VERIFY_USER', {
              cognitoUser,
              signature,
            })
            const authenticatedUser = await this.$store.dispatch(
              'AUTH_CHECK_CURRENT_USER',
            )
            const member = await getMember(authenticatedUser.username)
            await this.$store.dispatch('CURRENT_USER', member)

            this.redirectAfterLogin()
          }
        }
      } catch (error) {
        this.warning = 'Oops, something went wrong! Please try again'
        if (error.message === 'Cancelled signing message') {
          this.warning = error.message
        }
        await this.$store.dispatch('AUTH_LOGOUT')
        throw error
      } finally {
        this.isSpinnerActive = false
      }
    },
    redirectAfterLogin() {
      const urlToRedirect = this.$router.history.current.query['redirect']
      if (urlToRedirect) {
        this.$router.push(urlToRedirect)
      } else {
        this.$router.push({ name: 'HomeOrMain' })
      }
    },
  },
}
</script>

<style lang="scss" scoped>
@import '../../assets/scss/variables';

.contents__body {
  height: 100vh;
  background: $artong-black;

  .form__logo {
    padding: 100px 0 20px;

    .logo {
      width: 300px;
      fill: $artong-white;
    }

    a {
      b {
        color: $artong-white;
      }
      text-decoration: none;
    }
  }

  .form__box {
    background-color: $artong-white;
    padding: 35px 40px;
    text-align: left;
    display: inline-block;
    border-radius: 6px;
    box-shadow: 8px 8px 15px 0 rgba(0, 0, 0, 0.5);
    box-sizing: border-box;
    min-width: 320px;
    color: black;

    h1 {
      margin-top: 0;
    }

    h3 > span {
      text-decoration: underline;
    }

    input {
      display: block;
      width: 100%;
      padding: 16px;
      font-size: 14px;
      background-image: none;
      border: 1px solid $lightgray;
      border-radius: 3px;
      box-sizing: border-box;
      margin-bottom: 20px;
    }

    .form__username p {
      width: 230px;
    }

    .form__footer {
      .spinner {
        display: none;

        &.active {
          display: block;
          position: relative;
          height: 2px;
          width: 2px;
          margin: 0px auto;
          animation: rotation 0.6s infinite linear;
          border-left: 6px solid rgba(0, 174, 239, 0.15);
          border-right: 6px solid rgba(0, 174, 239, 0.15);
          border-bottom: 6px solid rgba(0, 174, 239, 0.15);
          border-top: 6px solid $artong-white;
          border-radius: 100%;
        }
      }

      @keyframes rotation {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(359deg);
        }
      }
      button {
        width: 100%;
      }

      & > span:nth-child(2) {
        align-self: center;
      }
    }
  }
}

@media only screen and (max-width: 599px) {
  .contents__body {
    padding-top: 0;

    .form__box {
      width: 80%;
      box-sizing: border-box;
      border-radius: 6px;
      box-shadow: 8px 8px 15px 0 rgba(0, 0, 0, 0.5);
      padding: 30px 25px 35px;

      .form__footer {
        flex-wrap: wrap;

        & > span:nth-child(1) {
          width: 100%;

          & > button {
            width: 100%;
            margin-bottom: 32px;
          }
        }

        & > span:nth-child(2) {
          align-self: center;
          text-align: center;
          flex: 0 0 100%;
        }
      }
    }
  }
}
</style>
